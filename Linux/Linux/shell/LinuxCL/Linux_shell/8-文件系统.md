## 文件系统

---

### 文件系统类别

```shell
# 查看文件系统的命令
df -T -h
```

* `EXT` 文件系统

  * 文件系统使用 `inode` 索引节点来跟踪和管理文件
  * 最大文件大小支持是 `2GB`
  * 文件的存储形式是 : 纯索引结构，导致文件的存储会分散化

* `EXT2` 文件系统

  * 修补了 `EXT` 文件系统的一些限制，但还是采用 `inode` 来管理文件 
  * 最大文件大小支持是 `2TB` ~ `32TB`  (为数据库中的文件考虑)
  * 文件存储的形式是 : 数据块分组的方式引入，加快寻找文件的速度
  * 但是文件系统不稳定(因为 `EXT2` 总是现写入数据在更新索引节点表的做法)

* 日志文件系统

  * 现将文件的更改写入临时文件中，当数据成功的吸入存储设备和索引节点表之后再删除日志
  * 日志系统的模式
    * 数据模式 : 索引节点和文件写入日志，性能差，安全
    * 有序模式 : 只写入索引节点，写入成功删除日志，性能和安全的折中
    * 回写模式 : 只有索引节点写入日志，不控制文件数据吸入，性更高，安全低
  * 性能低 : 日志一次，数据一次，两次访存
  * 例子
    * `EXT3` 文件系统
      * 给每一个存储设备加一个日志文件，采用默认有序模式
      * 无法恢复误删文件，没有数据的压缩功能，不支持加密文件操作
    * `EXT4` 文件系统
      * 支持数据加密，支持数据压缩
      * 引入**区段**功能 : 索引顺序结构
      * 引入块预分配技术 : 给即将增长的文件预留大的存储空间，用0将预分配的块填满并且不分给其他的块
    * `Reiser` 文件系统
      * 只支持回写日志模式 : 速度最快的文件系统
      * 尾部压缩技术
      * 在线调整文件大小

* 写时复制文件系统

  日志的另一种存在形式

---

### 文件系统操作

---

几个重要的概念

1. MBR

   1. 主引导记录（MBR，Main Boot Record）是位于磁盘最前边的一段引导（Loader）代码。它负责[磁盘](https://baike.baidu.com/item/%E7%A3%81%E7%9B%98)操作系统(DOS)对磁盘进行读写时分区合法性的判别、分区引导信息的定位，它由磁盘操作系统(DOS)在对硬盘进行初始化时产生的。

      1. **不属于任何一个操作系统**
      2. MBR（Main Boot Record 主引导记录区）位于整个硬盘的0磁道0柱面1扇区
      3. 主引导记录中包含了硬盘的一系列参数和一段引导程序。其中的硬盘引导程序的主要作用是检查分区表是否正确并且在系统硬件完成自检以后引导具有激活标志的分区上的操作系统，并将控制权交给启动程序。MBR是由分区程序（如Fdisk．exe）所产生的，**它不依赖任何操作系统，而且硬盘引导程序也是可以改变**的，从而实现多系统共存。

   2. 通常，我们将包含MBR引导代码的[扇区](https://baike.baidu.com/item/%E6%89%87%E5%8C%BA)称为主引导扇区。因这一[扇区](https://baike.baidu.com/item/%E6%89%87%E5%8C%BA)中，引导代码占有绝大部分的空间，故而将习惯将该扇区称为MBR扇区（简称MBR）。由于这一[扇区](https://baike.baidu.com/item/%E6%89%87%E5%8C%BA)承担有不同于磁盘上其他普通[存储空间](https://baike.baidu.com/item/%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4)的特殊管理职能，作为管理整个磁盘空间的一个特殊空间，它不属于磁盘上的任何分区，因而分区空间内的格式化命令不能清除主引导记录的任何信息

   3. 组成部分

      1. 主引导程序即主引导记录（MBR）（占446个字节）

         可在`fdisk`程序中找到，它用于硬盘启动时将系统控制转给用户指定的并在[分区表](https://baike.baidu.com/item/%E5%88%86%E5%8C%BA%E8%A1%A8)中登记了的某个操作系统。

      2. 磁盘[分区表](https://baike.baidu.com/item/%E5%88%86%E5%8C%BA%E8%A1%A8)项（DPT，Disk Partition Table, 64字节)

         由四个[分区表](https://baike.baidu.com/item/%E5%88%86%E5%8C%BA%E8%A1%A8)项构成（每个16个字节）。

         负责说明磁盘上的分区情况，其内容由磁盘介质及用户在使用`fdisk`定义分区时决定。

      3. 结束标志（占2个字节）

         其值为AA55，存储时低位在前，高位在后，即看上去是55AA（十六进制）

   4. 和grub的关系

      MBR是计算机最先执行的硬盘上的程序，但只有512字节大小。因为只有512字节，不能载入操作系统的核心，所以只能先载入一个可以载入计算机核心的程序，这个程序叫做引导程序。grub就是一个引导程序。一般用windows的默认安装的引导程序即可，但是因为一个硬盘上可能有多个不同的系统（windows,linux,mac等），而windows的引导程序只能引导windows系列，所以都会有grub这样的可以识别多种系统的通用型的引导程序。所以，和win的引导相比，grub的优势就是能引导多种系统

2. DPT  **硬盘分区表**

   参考链接

   1. https://www.cnblogs.com/alighie/p/8000919.html
   2. http://blog.csdn.net/qq_24817093/article/details/77743824

   硬盘分区表可以说是支持硬盘正常工作的骨架。操作系统正是通过它把硬盘划分为若干个分区，**然后再在每个分区里面创建文件系统，写入数据文件**

   1. 磁盘分区表只有64字节，每一个分区记录需要16字节，最多只能分4个分区(**主分区**)

   2. 为了能支持很多分区引入了扩展分区的概念， 也就是说，可以使用DPT中一条记录来记录扩展分区的信息，然后在扩展分区中再继续划分逻辑分区，而逻辑分区的分区信息则记录在扩展分区的第一个扇区中，如此则可以像链表一样划分出很多分区来。但注意，一个分区表中可以有1~4条主分区，但是最多只能有1个扩展分区

   3.  分区表之间是如何关联的，详细讲一下，分区表是一个单向链表，第一个分区表，**也就是位于硬盘第一个扇区中的DPT，可以有一项记录扩展分区的起始位置柱面，类似于指针的概念**，指向扩展分区,根据这项记录我们可以找到扩展分区的某柱面0磁头1扇区(CHS)，而这个扇区中又存放了**第二个分区表**，第二个分区表第一项记录一般表述了当前所在的逻辑分区的起始/终止柱面，第二项记录表述了下一个逻辑分区所在的0磁头1扇区(CHS),第三、第四项记录不存任何信息(图4)

   4. 磁盘分区表中记录了4个记录，在分区表所在的64字节容量中，总共分为四组记录区，**每组记录区记录了该区段的起始与结束的柱面号码。每一个分区我们叫做主分区或者扩展分区**

      ![](https://images2017.cnblogs.com/blog/1270514/201712/1270514-20171207195147534-1565959173.png)

3. 硬盘分区

   1. 关于 `/dev/sda`

      linux下设备都是以文件的方式来管理的，设备文件的位置为`/dev/`下
      硬盘应该类似于这样的`/dev/hda1`或`/dev/sda1`表示
      文件名的前两位为设备类型如并口硬盘为`hd`，串口硬盘或SCSI硬盘为`sd`
      文件名的第三位为该类型设备的顺序号为abc……，如IDE1口（并口硬盘）的主盘为hda，从盘为hdb；SATA（串口硬盘）第一个设备为sda，第二个设备为sdb，依次类推
      文件名的第四位为该硬盘的分区号1~4，为主分区或扩展分区，从5以后为逻辑分区，如IDE1口的C:为hda1，D:（D盘为该磁盘的第一个逻辑分区）为hda5，依次类推

   2. 第一块硬盘`/dev/sda`, 第二块硬盘 `/dev/sdb` 

   3. 硬盘 `/dev/sda` 的第一块分区 `/dev/sda1`，依次类推

   4. 分区和文件系统的关系

      一个硬盘的分区上需要有一个文件系统才能正常使用，但他们不是一个东西。所谓的格式化就是在分区上重建文件系统的过程

      e.g.

      就像 `mount` 命令，我们一次可以`mount`上一个文件系统(或者说是分区)，但不能说是`mount`一个硬盘

   5. **一块物理硬盘只能有: 一到四个主分区(但其中只能有一个是活动的主分区),或一到三个主分区,和一个扩展分区。分别对应hda1,hda2,hda3,hda4. / sda1,sda2,sda3,sda4**

   6. 分区的类型

      硬盘容量 = 主分区 + 扩展分区

      扩展分区容量 = 逻辑分区的总和

      * 主分区

      * 扩展分区 : 任何一个扩展分区都要占用主分区的号码

      * 逻辑分区 : 扩展分区能可以分若干个分区，每个分区都是个逻辑分区

        但[扩展分区](https://baike.baidu.com/item/%E6%89%A9%E5%B1%95%E5%88%86%E5%8C%BA)是不能直接用的，他是以[逻辑分区](https://baike.baidu.com/item/%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA)的方式来使用的，所以说扩展分区可分成若干[逻辑分区](https://baike.baidu.com/item/%E9%80%BB%E8%BE%91%E5%88%86%E5%8C%BA)。他们的关系是包含的关系，所有的逻辑分区都是[扩展分区](https://baike.baidu.com/item/%E6%89%A9%E5%B1%95%E5%88%86%E5%8C%BA)的一部分。

        **逻辑分区从/dev/sda5 的5开始5,6,7,8, ...**

      **主分区+扩展分区总共不能超过4个**

4. grub

---

1. `fdisk`

   * 必须创建分区来**容纳**文件系统
   * 使用命令 `fdisk` 
   * **可以创建扩展分区或者主分区，但是扩展分区需要使用其他的逻辑分区填充**

   ```shell
   sudo fdisk -l    # 查看当前的磁盘驱动器设备的设备名和其他的详细信息

   sudo fdisk /dev/sda    # 进入操作上面找到的磁盘驱动器

   # 主要命令参数
   1. d : 删除分区
   2. l : 显示可以使用的分区的类型(16进制的代号)
   3. m : 显示可以使用的命令选项(help menu)
   4. n : 创建一个新的分区
   5. p : 打印当前的分区信息
   6. t : 修改分区的类型(swap / ...)
   7. w : 只有执行了这个步骤，之前的改动才会写入MBR的分区表中

   # 如果我们执行w命令之后，显示我们需要重启或者执行partprobe命令的错误我们的解决思路
   # 	1. partprobe    # 有时候没有效果
   # 	2. reboot       # 重启的时候重新读入分区表

   # ---------- mkfs ----------- #
   # 上面的操作只是生成了对应的分区，但是我们需要使用一个特定的文件系统去格式化这个分区，Linux中支持很多的文件系统的格式化工具，我们可以选用，但是需要在使用之前鉴定是否可用
   type mkfs.ext4    # 检查mkfs.ext4工具是否可用
   type mkfs.ext3 
   ...
   mkfs.ext4 /dev/sda4

   # ---------- mount ---------- #
   # 上面的操作只是生成分区和文件系统，我们要使用分区的话，还需要挂载,假设我们创建了分区/dev/sda4,一般都挂在在/mnt文件夹下
   sudo mount -t ext4 /dev/sda4 ~/for_mount
   ```

2. `fsck`

   参考链接

   1. http://man.linuxde.net/fsck

   * 我们不能百分之百的保证我们的系统的文件系统是不会存在任何问题的，所以我们会使用 `fsck` 命令来恢复

   * 可以修复绝大多数的Linux文件系统(ext, ext2, ext3, ext4, JFS, XFS, ...)

   * `fsck`  命令一般查看文件 `/etc/fstab` 中挂载在系统中的存储设备的文件系统来自动的修复，如果没有挂载需要使用参数 `-t` 指定

   * 使用方式

     ```python
     1. -t 指定文件系统
     2. -a 检测到错误，自动修复
     3. -y 检测到错误，自动修复

     fsck -y /dev/sda1    # 如果不知道是哪里除了问题， 直接运行 fsck
     ```

     ​