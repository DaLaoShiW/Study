## 文件系统

#### 文件和文件系统

1. 文件定义

   文件时从存储在外部存储器的具有富豪命的相关信息的集合

2. 文件属性

   * 文件名
   * 文件标识
   * 文件位置
   * 文件类型
   * 文件保护方式

3. FCB文件控制块

   1. 文件控制块中包含了文件的说明信息和管理控制信息
   2. **保存在文件目录中，目录也已文件的形式保存在外存中**

4. 文件组成

   1. FCB
   2. 文件体 : 文件的实际内容

5. 文件分类

   * 普通文件 : ASCII / 二进制
   * 目录文件 : 检索普通文件
   * 特别文件 : 对特殊文件的操作转为对设备的操作

6. 文件系统

   提供管理文件的软件机构

   * 文件管理程序
   * 对应数据结构
   * 被管理的文件

   功能

   * **按名存取文件 : 文件系统的目的**
   * 管理文件存储器
   * 提供多样文件结构和存取方法
   * 提供文件操作命令
   * 保证文件的安全
   * 文件共享

#### 文件目录结构

* 实现文件系统的目的和主要功能
* 记录文件名字和存放物理地址的**映射表**
* 表中包含FCB
* 存放在文件存储器中
* 存在多种结构便于文件管理
* 结构
  * 一级目录结构
    * 一维目录表
    * 添加 / 删除 / 查找类似于数组操作
    * 文件重名 / 查找效率低下
  * 二级目录机构(解决重名问题)
    * 按照用户建立目录 - 用户文件目录
    * 系统维护主目录 : 记录用户和对应的用户文件目录的物理地址
    * 存取速度依然很慢，不可共享(用户引入带来的问题)
  * 多机目录结构
    * 树型
      * 文件固有名 : 根到目录上文件的符号拼接而成
      * 当前目录 / 相对路径
      * 无环图目录结构
        * 硬链接 : FCB相同，在共享目录项中简单地重复被共享文件的信息，因此两个目录项完全相同
        * 软连接 : 存放目标文件的绝对路径，创建一个新目录项，其中存有指向另一个文件或目录的**绝对路径名**
      * 优点
        * 层次清晰，利于管理保护，利于文件分类，解决重名问题，提高检索速度
      * 缺点
        * 管理开销大，逐次访盘影响访问速度，连接的形式共享

#### 文件逻辑结构和存取方法

1. 文件系统重要作用是 : 在逻辑文件和物理文件建立映射，实现二者相互转换
2. 文件的逻辑结构
   1. 字节流 : Linux  /  Windows
   2. 记录式
      1. 定长式
      2. 变长式
3. 存取方式
   1. 顺序存取 : 在前一次的存取的基础上存取，**变长记录式**
   2. 直接存取 : 随机存取，纪录式

#### 文件的物理结构和存储介质

1. 文件的物理结构

   * 为了有效的管理文件存储器的空间，划分成大小相等的块(**物理块**)包含一个扇区或者几个连续的扇区

   * 逻辑记录长度和物理块大小一致

   * 连续文件

     * 顺序文件物理结构，物理上连续存储
     * 简单，只用记住第一块的地址和块数即可
     * 支持随机存取和顺序存取
     * 访问速度快
     * 不可动态修改长度，不灵活,容易产生碎片

   * 链接文件

     * 连续记录分配在不连续的**物理块**中,设置指针连接下一个物理块
     * 只能顺序存取，单是可以构建一维的数组构成一个线性表实现顺序和随机读取(只是指针的索引)
     * 但是工作期间，映射表必须存在于主存中(将文件表加载在主存中占用宝贵内存空间)

   * 索引文件

     * 索引表指示文件的逻辑块和物理块的映射关系
     * 索引表
       * 文件名
       * 文件对应的索引表块号(索引表的物理块号) : 
         * 一个索引块中存放这对应的文件的物理块的物理地址
         * 可以随机，顺序访问
         * 但是物理表文件过多需要多级索引
       * 文件长度
     * 增加了存储空间的开销，降低了文件的存取速度(至少两次访问外存，索引表一次，文件一次)
     * 文件可以动态修改，灵活性增加

   * 索引顺序结构

     方便预读取

2. 存储介质

   1. 硬盘低级格式化：

      将磁盘划分成若干磁道、扇区。每个扇区512B，扇区的头标记录其柱面号、磁头号和扇区号。由生产厂家完成。

   2. 分区格式化：

      用FORMAT命令。对分区进行具体的数据组织，即制作文件系统。

   3. 硬盘主引导扇区(0面0道1扇区512B)组成

      1. 硬盘主引导程序
      2. 描述分区划分的信息表
      3. 分区扇区结束标识AA55H

   4. 分区划分

      1. 主dos分区(dos,windows)
      2. 扩展dos分区(数据盘)
      3. 非dos分区

   5. 活动系统  : 加电后被引导的系统

   6. 存取时间 = 寻道时间 + 旋转延迟时间 + 存取时间

#### 文件记录的组块和分解

1. 文件记录的组块
   * 多个逻辑记录存放在物理块中
   * 块中的记录个数叫做块因子
2. 记录分解
   * 从物理块中将逻辑记录分解出来的工作叫做记录的分解

#### 文件存储器的存储空间管理

1. 空白文件目录
   * 连续未用的空闲盘块区，系统为所有的空白文件建立表
   * 适合文件的静态分配
2. 空闲区链
   * 将所有的空闲块连城链，空闲块链，保留链头指针
   * 适合动态分配，工作效率低，回收空闲块效率低
   * 优化 - 成组空闲块链
     * 利用盘空闲块来管理盘上的空闲块，每个磁盘块记录尽可能多的空闲块而成一组。各组之间用链指针链接在一起
3. 位示图 Linux / Windows
   1. 磁盘块中连续存放
   2. 比较容易找到连续的空闲块
   3. 易于保存在主存中实现文件的分配和回收工作

#### 文件的共享和保护

1. 存取控制

   防止核准的用户误用文件或者未核准的用户存取文件

   * 保护域 : 每个对象都有惟一的名字和允许施加的操作,一个域是一组（对象、存取权限）偶对
   * 存取控制表(进程的构建保护域)
     1. 每个对象都有一个有序表，包含了存取该对象的所有域
     2. 记录在FCB

#### 文件操作命令

打开文件

* 按照文件路径名找到文件目录项
* 找到FCB入内存记录在系统打开文件表(文件对象的链表)中
* 构建文件对象

#### 文件组织结构

文件系统是用户和外存设备的接口

组织结构

* 应用程序接口 : 用户提供的命令语法的正确性
* 逻辑文件系统 : 管理目录
* 文件组织模块 : 逻辑记录->物理块号
* 基本文件系统 : 上层的命令转化成设备驱动程序的调用
* I/O调度和控制模块
  * 设备驱动，中断模块
  * 命令的排队
  * 转换成I/O指令和对应的地址

#### 存储器映射文件

1. 文件系统的读文件：先把文件读入系统缓冲区，再送入进程私有地址空间

2. 存储器映射文件 : 

   将文件映射到进程私有地址空间的一个区域，返回起始虚地址，仅当需要对文件存取时，才传输文件数据

3. 访问页不存在发生缺页中断

4. OS提供映射文件的系统调用







## 总结

1. **什么是文件和文件系统? 文件系统的主要功能。UNIX系统如何对文件进行分类？它有什么好处？**

   1. 文件是存储在外部存储器上的具有符号名的相关信息的集合,	OS中管理文件的软件机构
   2. 功能
      - **按名存取文件 : 文件系统的目的**
      - 管理文件存储器
      - 提供多样文件结构和存取方法
      - 提供文件操作命令
      - 保证文件的安全
      - 文件共享
   3. 普通，目录，特殊
   4. ？？？？？？？

2. **文件目录的作用是什么?文件目录项通常包含哪些内容? 文件控制块**

   1. 文件名和物理地址的映射表
   2. FCB

3. **文件的逻辑结构有几种形式？文件的存取方法？**

   1. 字节，记录(定长，变长)
   2. 顺序，直接(随机)

4. **文件的物理结构有哪几种?对于不同的结构，文件系统是如何进行管理的?**

   1. 连续 : 文件目录表
   2. 链接 : 线性表
   3. 索引 : 每个文件一个索引表
   4. 索引顺序

5. **DOS文件卷的结构，DOS系统的文件物理结构是什么？**

   1. DOS文件卷：
      1. 存有整个文件存储空间的使用情况。FAT文件分配表
      2. 根目录区：存放根目录文件。
      3. 文件数据区：存放文件。
   2. DOS : 链接结构(FAT)

6. **文件存储空间的管理方法有几种?它们各是如何实现文件存储空间的分配和回收的?**

   1. 空白文件目录 / 空闲块链表 / 位示图
   2. P113

7. **建立多级目录有哪些好处?文件的重名和共享问题是如何得到解决的?**

   1. 优点：

      层次结构清晰，便于管理和保护；有利于文件分类；**解决重名问题**；提高文件检索速度；能够控制存取权限

   2. 重名问题

      目录 + 文件名

   3. 共享

      链接技术

8. ACL

   为存取控制矩阵中的每一列建立一张存取控制表(ACL)，用一有序对(域, 权集)表示

9. **理解内存映射文件的过程**

   将文件映射到进程私有地址空间的一个区域，返回起始虚地址，仅当需要对文件存取时，才传输文件数据