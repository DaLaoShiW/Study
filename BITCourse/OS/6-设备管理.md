## 设备管理

1. 目标功能
   1. 功能 : I/O系统负责管理所有I/O设备
   2. 目标 : 要建立一个通用的、一致的设备访问接口，使用户能够方便地使用I/O设备

#### I/O硬件的组成

1. I/O设备分类

   1. 字符设备 : 人机交互设备，慢设备
   2. 块设备 : 以块为单位传输数据，高速设备
   3. 网络通信设备 : 中速设备，
   4. 其他 : 时钟(不是上述的三种的任何一种,按预先规定好的时间间隔产生中断),文件系统(只处理抽象的块设备，具体的操作并不是文件系统的工作,单文件系统调用设备驱动程序完成工作)

2. 设备控制器

   * I/O设备一般由机械电子两部分构成，分开处理以实现模块化，其中的**电子设备**称为设备控制器,**机械部分**是设备本身

   * 设备控制器处于CPU和I/O设备之间，接收从CPU发来的命令，控制I/O设备工作

   * 设备控制器寄存器与设备驱动程序交互

     * 控制寄存器：接收CPU发送的读写命令
     * **状态寄存器：包含设备的状态信息**
     * 数据缓冲寄存器：通常为1B至4

   * DMA控制器

   * 磁盘控制器

     磁盘控制器把串行的位流组装为字节，存入控制器内部的数据缓冲区中，形成以字节为单位的块，送入CPU

3. I/O数据传输的控制方式

   1. 程序查询方式
      * 循环查询设备是够处于完成输出的状态
      * CPU忙等串行工作
   2. 中断方式
      * 启动设备后CPU和外设**并行运行**
      * 中断来临
      * CPU响应中断，执行设备的中断处理程序
      * 返回执行被中断进程
   3. DMA
      1. 中断在一定程度上可以使CPU和设备并行工作
      2. 但是频繁的中断会严重的干预CPU的正常运行(中断频繁和设备多的情况下)
      3. DMA(直接存储器存取)，允许DMA控制存储器的地址线，DMA直接控制设备和主存之间的数据交换(类似卫星机)
      4. 过程
         1. CPU将DMA命令块(数据的起始地址，目的地址，数据量)写入主存，将命令块的地址写入DMA控制器,**CPU结束工作**
         2. 磁盘设备和存储器之间的数据传送不需要CPU的介入，CPU仅在数据传输的**开始**和**完成**时进行简单的干预工作，大大减轻了CPU的负担
      5. 代价
         * DMA取代CPU，接管地址总线的控制权，控制与主存的数据交换。使CPU访问总线时速度会变慢。
         * 使用CPU的周期运行
   4. 通道
      1. 专用的I/O处理机，存在自己的指令系统，可以执行若干条通道指令
      2. 可以做到一个通道控制多台设备，进一步减轻了CPU的负担
      3. 通道类型
         1. 字节多路通道
            1. 字节为单位传送信息
            2. **分时**执行多个通道程序(类似轮转法，一个通道程序一个通道程序的执行)
            3. 连接大量慢速设备(保证我们轮转适应慢速)
         2. 选择通道
            1. 成组的方式工作，每次传送一批数据
            2. 传送速度高
            3. 选择通道在一段时间内只能执行一个通道程序，只允许一台设备进行数据传输
            4. 连接高速设备
         3. 数组多路通道
            1. 有些设备高速但是定位花费时间长(字节多通路不合适，选择通道定位时间花费过多)
            2. 对于多组设备我们可以同时启动开始移臂，然后按序执行传送工作(多道程序硬件实现)
      4. 通道命令
         1. 通道有更强的I/O处理能力
         2. 存在自己的指令系统，接收CPU的委托独立执行自己的通道程序，管理控制输入输出工作

#### I/O软件的组成

1. 思想

   * 分层构成软件系统
   * 较低的软件层可以让高层次独立于硬件，高层可以给用户提供利好的接口
   * 软件层次结构
     1. 用户层I/O接口
     2. 独立于设备的软件
     3. 设备驱动程序
     4. 中断处理程序
     5. I/O硬件

2. 设计目标

   1. 设备独立性
   2. 设备统一命名
   3. 错误处理
   4. 缓冲技术
   5. 设备分配

3. 软件功能

   1. 中断处理程序

      1. 响应中断，执行中断处理程序
      2. 传输错误，判断是否重新传输，否则报告错误
      3. 传输正确，唤醒等待进程转为就绪态
      4. 返回被中断的进程，或转进程调度

   2. 设备驱动程序

      1. OS中唯一知道设备控制器的配置情况(寄存器个数和作用)
      2. 与设备密切相关的代码放在设备驱动程序层，每个设备驱动程序处理一种**类型**设备，提供类似文件的API
      3. 功能
         1. 设备初始化 : 初始化状态
         2. 启动设备例程 : 负责启动设备进行数据传输
         3. 中断处理例程 : 处理各种设备的中断请求

   3. 独立于设备的软件

      * 实现向用户级软件提供设备驱动程序统一接口

      * 设备命名

        * 将设备的符号名(逻辑设备名)映射到正确的设备驱动程序上
          1. 主设备号 : 分配正确的中断设备驱动程序
          2. 次设备号 : 作为参数确定读写那一台终端

      * 设备保护

        1. 所有的I/O指令都是特权指令
        2. 只可以通过系统调用实现

      * 提供和设备无关的块尺寸

        不同的磁盘的扇区大小不一致，软件向高层次的软件屏蔽这样的信息，使用登场的逻辑长度

      * 缓冲技术

        1. 实现对缓冲控制块的管理
        2. 解决设备和设备之间的处理速度不匹配的问题，空间换时间
        3. 分类
           1. 单缓冲 : 进程和设备读写在缓冲区上是串行处理的,效率低
           2. 双缓冲 : 效率高
           3. 多缓冲和缓冲池 : 现代使用

      * 设备的分配和调度

        1. 静态分配 : 在进程运行前，将所有的设备全部赋给进程，设备利用率低，可以防止死锁
        2. 动态分配 : 进程运行时分配，设备利用率高，但是容易引起死锁
        3. 虚拟设备
           1. 将独享设备改造成共享设备
           2. 缓输出技术(Spooling技术)
              1. 打印数据的时候，操作系统不分配实际的设备，而是分配在共享设备上(磁盘)一部分空间上
              2. 经进程的每一组输出缓冲到**磁盘上的一个文件上**
              3. 进程结束了排队打印输出
              4. 可节省进程和设备的传输时间(缩短进程周转时间)，提高**设备的利用率**
              5. 可以防止死锁
        4. 共享设备 : 分配简单，用户共享

      * 错误处理

        1. 绝大多数的错误和设备是密切相关的，一般需要设备驱动程序的处理
        2. 但是如果错误仍无法处理应该提交给独立的软件层处理(调用者)

   4. 用户层的I/O接口

      1. I/O库函数
         * 大部分存在于操作系统中
         * 少部分库函数(I/O系统调用使用库函数实现的)
      2. Spooling系统

4. 同步异步I/O

   1. 应用程序大部分是同步I/O : 发出请求之后进程阻塞直到传输完成

   2. 异步I/O : 运用程序和设备程序的并行运行，减少周转时间，提高进程的运行速度

      进程监控地址空间中的某一个变量监视传输数据的情况，触发软件中断????????????(??软件实现??)

   3. 原则

      1. 不启动缓冲，可以预测工作时间 , 同步
      2. 长时间无法确定时间 , 异步

#### 磁盘管理

0. 提高磁盘I/O效率的方式
   1. 高性能磁盘
   2. 好的调度算法
   3. 设置磁盘高速缓冲区

1. 磁盘调度
   1. 磁盘操作十分频繁
   2. 使用磁盘调度算法实现对此案的高速存取
   3. 一次只允许一个进程访问磁盘，使用调度算法决定访问进程的顺序(**磁盘调度**)
      1. 移臂调度 : 柱面位置选择(耗费时间最长，主要考虑移臂调度的磁盘调度算法)
      2. 旋转调度 
2. 移臂调度算法
   1. 先来先服务调度算法(FCFS)
      * 容易实现，公平合理
      * 不一定是最好的调度
      * 完全不考虑队列中的请求的情况
   2. 最短寻道时间优先算法(SSTF)
      * 总是选择下一次移动距离最小的磁道
      * 虽然闭FCFS优秀但是是局部最优解
   3. 扫描法(SCAN)
      * 磁头从一端到另一端的过程中随时处理到达磁道上的服务(任务来临的动态性质考虑)，知道移动到磁道另一端为止
      * 在另一端磁头反转继续
      * 磁头总是从一端到另一端
      * 如果一个任务刚好落在移动的前方可以立即被处理，但是如果在后方则需要等待较长时间才可以被处理
   4. 循环扫描法(C-SCAN)
      * 对扫描法来说，我们的磁头如果扫过整个磁道反向后，移动方向前方的请求密度必定比后头的高，所以引入循环扫描法
      * 于扫描法不同的是，当扫描到另一端是立即将磁头返回值起点(回程不处理任何请求)
      * 提供均衡的服务
   5. 查询或者循环查询(C-LOOK)
      * 将磁头直接返回的方法实际中并未采用，耗时
      * 磁头在向前移动前**查询**前方是否有请求，有继续，否则立即改变方向从最小的I/O请求开始
   6. ??????课后题??????

#### 总结

1. **I/O设备通常大致可分为哪两大类？各自传输的信息单位有什么特点？**？？？？？？？

   1. 字符设备 : 慢设备，字符为单位
   2. 块设备 : 块设备，块为单位

2. **常用的四种数据传输方式。**

   1. 程序查询方式
   2. 中断
   3. DMA
   4. 通道

3. **根据设备的使用方式，设备被分为几种类型？何为虚拟设备？它是通过什么技术实现的？**???????

   1. 字符设备
   2. 块设备
   3. 网络通信设备
   4. 虚拟设备 : 
      1. 是指设备本身是独占设备，经过虚拟技术处理，可以把它改造成共享设备
      2. spooling技术实现

4. **按照设备管理的层次结构，I/O软件划分为几层？各层主要实现哪些功能？**

   1. 用户的I/O接口 : 提供I/O系统调用
   2. 独立于设备的程序 : 
      1. 设备命名
      2. 设备保护
      3. 块尺寸
      4. 缓冲技术
      5. 设备分配
      6. 错误处理
   3. 设备驱动程序
      1. 设备初始化
      2. 启动数据传输
      3. 中断处理
   4. 中断处理程序
   5. I/O硬件

5. **何为设备的独立性？**

   **（设备独立性是指用户及用户程序不受系统配置的设备类型和具体设备的台号的影响。用户只是使用逻辑设备，具体的映射由操作系统完成。）**

6. **什么是SPOOLING技术？**

7. **一个特定磁盘上的信息如何进行编址？**

   柱面号、磁头号和扇区号

8. **要将磁盘上一个块的信息传输到主存需要系统花费哪些时间？**

   1. 寻道时间
   2. 旋转延迟时间
   3. 读/写传输时间

9. **磁盘调度算法**

   ​